name: Bibbi

on:
  push:
    branches:
      - develop
      - feature/*
    tags:
      - "v*"
  
jobs:  
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v3

      - name: Tuist Clean Command
        uses: tuist/tuist-action@0.13.0
        with:
          command: 'clean'
          arguments: ''

      - name: Tuist Fetch Command
        uses: tuist/tuist-action@0.13.0 
        with:
          command: 'fetch'
          arguments: ''

      - name: Tuist Generate Command
        uses: tuist/tuist-action@0.13.0 
        with:
          command: 'generate'
          arguments: ''

      - name: xcode build üõ†Ô∏è
        run: xcodebuild clean build -workspace "Bibbi.xcworkspace" -scheme "App" -destination "platform=iOS Simulator,name=iPhone 13 mini,OS=latest" -enabledCodeCoverage YES build test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1.2.1
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  deploy:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: fastlane deploy start
      run: echo "fastlane deploy start"
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
