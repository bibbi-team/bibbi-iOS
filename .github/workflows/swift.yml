name: Bibbi

on:
  push:
    branches:
      - develop
      - feat/*
      - fix/*
    tags:
      - "v*"
  
jobs:  
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        xcodebuild-scheme: ['App']
        
    steps:
      - uses: actions/checkout@v3
      - uses: jdx/mise-action@v2

      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
            xcode-version: latest
            
      - name: Checkout branch
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bring Bibbi ignored file with Config
        uses: actions/checkout@v3
        with: 
          repository: depromeet/14th-team5-iOS-ignored
          path: depromeet/14th-team5-iOS/14th-team5-iOS/XCConfig
          token: ${{secrets.ACTION_TOKEN}}

      - name: Setting Master Key
        run: | 
          echo "${{secrets.MASTER_KEY}}" >> Tuist/master.key
        
      - name: Install Tuist CLI
        run: bash <(curl -Ls https://install.tuist.io)
        
      - name: Install FastLane 
        run: gem install fastlane -v 2.219.0

      - name: Tuist Clean Command
        run: tuist clean
      
      - name: Tuist Fetch Command
        run: tuist fetch

      - name: fastlane upload_testflight
        env:
          KEYCHAIN_NAME: ${{secrets.KEYCHAIN_NAME}}
          KEYCHAIN_PASSWORD: ${{secrets.KEYCHAIN_PASSWORD}}
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
          MATCH_PASSWORD: ${{secrets.MATCH_PASSWORD}}
          MATCH_PERSONAL_TOKEN: ${{ secrets.MATCH_PERSONAL_TOKEN}}
          PRD_SCHEME: ${{secrets.PRD_SCHEME}}
          SLACK_HOOK_URL: ${{ secrets.SLACK_HOOK_URL }}
          APP_NAME: ${{secrets.APP_NAME}}
          TEAM_ID: ${{secrets.TEAM_ID}}
          WIDGET_NAME: ${{secrets.WIDGET_NAME}}
        run: fastlane github_action_upload_testflight

      - name: Tuist generate Command      
        run: tuist generate

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1.2.1
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
